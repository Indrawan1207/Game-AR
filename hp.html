<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sultan THR AR | Versi Stabil</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #064E3B; margin: 0; overflow: hidden; }
    canvas { width: 100vw; height: 100vh; object-fit: cover; cursor: none; }
    .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }

    .glass-sultan {
      background: rgba(6, 78, 59, 0.85);
      backdrop-filter: blur(15px);
      border: 3px solid #FDE047;
      border-radius: 2rem;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
    }

    .btn-interact { pointer-events: auto; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .btn-interact:hover { transform: scale(1.06) rotate(-1deg); }

    .user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #FDE047; object-fit: cover; }

    /* Flash */
    .flash-effect { position: fixed; inset: 0; background: white; z-index: 100; opacity: 0; pointer-events: none; }
    @keyframes do-flash { 0% { opacity: 1; } 100% { opacity: 0; } }

    /* Confetti */
    .confetti {
      position: fixed; top: -20px; z-index: 200;
      border-radius: 4px; opacity: .95; will-change: transform;
      animation: fall 1200ms linear forwards;
    }
    @keyframes fall { to { transform: translateY(calc(100vh + 60px)) rotate(540deg); opacity: 1; } }

    /* Camera Modal */
    .modal-bg { background: rgba(0,0,0,.72); }
    .cam-frame { aspect-ratio: 16 / 9; width: min(720px, 92vw); border-radius: 1.5rem; overflow: hidden; border: 2px solid rgba(255,255,255,.2); }
    .cam-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .mini-preview { width: 90px; height: 90px; border-radius: 1.25rem; border: 2px solid #FDE047; object-fit: cover; }
  </style>
</head>

<body>
  <div id="flash" class="flash-effect"></div>

  <div id="loading" class="fixed inset-0 bg-[#064E3B] z-[100] flex flex-col items-center justify-center text-white">
    <div class="w-20 h-20 border-4 border-yellow-400 border-t-transparent rounded-full animate-spin mb-4"></div>
    <p class="font-bold tracking-widest text-yellow-400 uppercase text-xs">Menghubungkan ke Satelit Sultan...</p>
  </div>

  <div id="container" class="relative">
    <video id="input_video" class="hidden" playsinline></video>
    <canvas id="output_canvas"></canvas>

    <!-- HUD -->
    <div id="game-hud" class="ui-layer p-6 flex justify-between items-start hidden">
      <div class="glass-sultan p-4 flex items-center gap-4 text-white min-w-[280px]">
        <img id="avatar-p1" src="https://ui-avatars.com/api/?name=P1&background=random" class="user-avatar" />
        <div>
          <p class="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Sultan 1</p>
          <h2 id="score1" class="text-2xl font-black">Rp 0</h2>
        </div>
      </div>

      <div class="glass-sultan px-8 py-2 text-center text-white">
        <p class="text-[9px] font-bold text-yellow-400 uppercase">Waktu</p>
        <h2 id="timer" class="text-3xl font-black tabular-nums">60</h2>
        <p id="level" class="text-[10px] font-black text-yellow-300 mt-1 tracking-widest">LV 1</p>
      </div>

      <div class="glass-sultan p-4 flex items-center gap-4 text-white text-right flex-row-reverse min-w-[280px]">
        <img id="avatar-p2" src="https://ui-avatars.com/api/?name=P2&background=random" class="user-avatar" />
        <div>
          <p class="text-[10px] font-black text-yellow-400 uppercase tracking-widest">Sultan 2</p>
          <h2 id="score2" class="text-2xl font-black">Rp 0</h2>
        </div>
      </div>
    </div>

    <!-- MENU -->
    <div id="menu-overlay" class="ui-layer flex items-center justify-center bg-black/60">
      <div class="glass-sultan p-10 max-w-lg text-center text-white pointer-events-auto">
        <h1 class="text-5xl font-black text-yellow-400 mb-2 tracking-tighter">SULTAN THR</h1>
        <p class="text-sm opacity-80 mb-8 italic">"Siapkan kantong, rebut rezeki lebaran!"</p>

        <div class="flex justify-center gap-6 mb-6">
          <div class="text-center">
            <img id="preview-p1" src="https://ui-avatars.com/api/?name=P1&background=FDE047" class="w-20 h-20 rounded-2xl border-2 border-white object-cover" />
            <p class="text-[10px] mt-2 font-bold uppercase">Foto P1</p>
          </div>
          <div class="text-center">
            <img id="preview-p2" src="https://ui-avatars.com/api/?name=P2&background=FDE047" class="w-20 h-20 rounded-2xl border-2 border-white object-cover" />
            <p class="text-[10px] mt-2 font-bold uppercase">Foto P2</p>
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <button id="btn-open-cam" class="btn-interact w-full bg-yellow-400 text-green-900 py-4 rounded-xl font-black text-xl shadow-xl">
            <i class="fas fa-camera mr-2"></i> AMBIL FOTO SULTAN
          </button>
          <button id="btn-start" class="btn-interact w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-xl font-black text-xl shadow-xl">
            <i class="fas fa-play mr-2"></i> MULAI PANEN
          </button>
          <button id="btn-toggle-game-mirror" class="btn-interact w-full bg-white/10 hover:bg-white/15 text-white py-3 rounded-xl font-bold">
            <i class="fas fa-right-left mr-2"></i> MIRROR GAMEPLAY: ON
          </button>
        </div>
      </div>
    </div>

    <!-- CAMERA CAPTURE MODAL -->
    <div id="cam-overlay" class="ui-layer modal-bg hidden flex items-center justify-center">
      <div class="glass-sultan p-6 max-w-3xl text-white pointer-events-auto">
        <div class="flex items-start justify-between gap-4">
          <h2 class="text-2xl font-black text-yellow-400">Capture Foto Sultan</h2>
          <button id="btn-close-cam" class="btn-interact bg-white/10 hover:bg-white/15 px-4 py-2 rounded-xl font-bold"><i class="fas fa-xmark"></i></button>
        </div>
        <div class="mt-4 cam-frame"><video id="cam_preview" class="cam-video" playsinline muted autoplay></video></div>
        <div class="mt-4 flex items-center justify-between flex-wrap gap-3">
          <div class="flex gap-4">
            <div class="text-center">
              <img id="cap-p1" class="mini-preview" src="https://ui-avatars.com/api/?name=P1&background=FDE047" />
              <button id="btn-cap-p1" class="btn-interact mt-2 bg-yellow-400 text-green-900 px-3 py-1 rounded-lg font-bold text-xs">Foto P1</button>
            </div>
            <div class="text-center">
              <img id="cap-p2" class="mini-preview" src="https://ui-avatars.com/api/?name=P2&background=FDE047" />
              <button id="btn-cap-p2" class="btn-interact mt-2 bg-yellow-400 text-green-900 px-3 py-1 rounded-lg font-bold text-xs">Foto P2</button>
            </div>
          </div>
          <button id="btn-continue" class="btn-interact bg-green-500 hover:bg-green-400 text-green-950 px-6 py-3 rounded-xl font-black">Lanjut Main</button>
        </div>
      </div>
    </div>

    <!-- RESULT -->
    <div id="result-overlay" class="ui-layer flex items-center justify-center bg-black/80 hidden">
      <div class="glass-sultan p-8 max-w-2xl text-center text-white pointer-events-auto">
        <h2 id="winner-text" class="text-4xl font-black mb-6 text-yellow-400 uppercase">PLAYER 1 MENANG!</h2>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-white/10 p-4 rounded-xl">
                <p class="text-xs opacity-60">Total P1</p>
                <h4 id="final-score1" class="text-xl font-bold">Rp 0</h4>
            </div>
            <div class="bg-white/10 p-4 rounded-xl">
                <p class="text-xs opacity-60">Total P2</p>
                <h4 id="final-score2" class="text-xl font-bold">Rp 0</h4>
            </div>
        </div>
        <img id="cert-preview" class="w-full rounded-xl border-2 border-yellow-400 mb-6" />
        <div class="flex gap-3 justify-center">
          <button id="btn-download-cert" class="btn-interact bg-blue-600 text-white py-4 px-6 rounded-xl font-bold"><i class="fas fa-download mr-2"></i> DOWNLOAD</button>
          <button onclick="location.reload()" class="btn-interact bg-yellow-400 text-green-900 py-4 px-6 rounded-xl font-bold">REMATCH</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const flash = document.getElementById('flash');

  const WIDTH = 1280, HEIGHT = 720, NET_X = WIDTH/2;
  canvasElement.width = WIDTH; canvasElement.height = HEIGHT;

  // Variables
  let gameState = "MENU";
  let score = { p1:0, p2:0 };
  let timer = 60, startTime = 0, level = 1;
  let moneyItems = [];
  let userPhotos = { p1:null, p2:null };
  let GAME_MIRROR = true; // DEFAULT ON

  // Performance Variables (FIX: TRACK_SCALE DITAMBAHKAN)
  let TRACK_SCALE = 0.55;
  let potato = false;
  let MAX_ITEMS = 14;
  let MP_INTERVAL = 40;
  let SPAWN_PROB_BASE = 0.045;
  let lastMp = 0;

  // Trails
  let trails = { p1: new Array(12).fill(null), p2: new Array(12).fill(null) };
  let trailIdx = { p1:0, p2:0 };

  const formatRupiah = (n) => "Rp " + (n|0).toLocaleString('id-ID');

  // Audio
  let audioCtx = null;
  function playTone(f, d, t="sine", v=0.08) {
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = t; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    gain.gain.setValueAtTime(v, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+d);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime+d);
  }

  class Money {
    constructor(side) {
      this.side = side;
      const r = Math.random();
      this.type = r<0.15?'BOMB':(r<0.30?'ANGPAO':(r<0.50?'RED':'BLUE'));
      this.x = side==='p1' ? 60+Math.random()*(NET_X-180) : (NET_X+120)+Math.random()*(NET_X-200);
      this.y = -80;
      this.vy = (2+Math.random()*4) * (1+level*0.2);
      this.vx = Math.sin(Math.random()*5)*2;
      this.angle = 0;
    }
    update() { this.y += this.vy; this.x += this.vx; this.angle += 0.05; return this.y < HEIGHT+100; }
    draw() {
      canvasCtx.save();
      canvasCtx.translate(this.x, this.y);
      canvasCtx.rotate(Math.sin(this.angle)*0.3);
      if(this.type==='BOMB') {
        canvasCtx.fillStyle="#333"; canvasCtx.beginPath(); canvasCtx.arc(0,0,30,0,Math.PI*2); canvasCtx.fill();
        canvasCtx.fillStyle="white"; canvasCtx.font="bold 20px Arial"; canvasCtx.fillText("ðŸ’¥",-15,8);
      } else if(this.type==='ANGPAO') {
        canvasCtx.fillStyle="#D4AF37"; canvasCtx.fillRect(-30,-40,60,80);
        canvasCtx.fillStyle="white"; canvasCtx.font="bold 25px Arial"; canvasCtx.fillText("ðŸ§§",-15,10);
      } else {
        canvasCtx.fillStyle = this.type==='RED' ? "#EF4444" : "#3B82F6";
        canvasCtx.fillRect(-55,-27,110,55);
        canvasCtx.fillStyle="white"; canvasCtx.font="bold 16px Courier"; canvasCtx.fillText(this.type==='RED'?"100k":"50k",-30,5);
      }
      canvasCtx.restore();
    }
  }

  const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
  hands.setOptions({ maxNumHands:2, modelComplexity:0, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });

  hands.onResults((results) => {
    document.getElementById('loading').style.display = 'none';
    canvasCtx.save();
    if(GAME_MIRROR) {
        canvasCtx.scale(-1, 1); canvasCtx.translate(-WIDTH, 0);
    }
    canvasCtx.drawImage(results.image, 0, 0, WIDTH, HEIGHT);
    canvasCtx.restore();

    canvasCtx.fillStyle = "rgba(6, 78, 59, 0.4)"; canvasCtx.fillRect(0,0,WIDTH,HEIGHT);
    
    // Draw Net
    canvasCtx.strokeStyle="#FDE047"; canvasCtx.lineWidth=4; canvasCtx.beginPath(); canvasCtx.moveTo(NET_X,0); canvasCtx.lineTo(NET_X,HEIGHT); canvasCtx.stroke();

    if(results.multiHandLandmarks) {
      for(const lms of results.multiHandLandmarks) {
        const tip = lms[8];
        // FIX MIRROR LOGIC
        const px = (GAME_MIRROR ? (1 - tip.x) : tip.x) * WIDTH;
        const py = tip.y * HEIGHT;
        const side = px < NET_X ? 'p1' : 'p2';

        trails[side][trailIdx[side]] = {x:px, y:py};
        trailIdx[side] = (trailIdx[side]+1)%12;

        if(gameState==="PLAY") {
          for(let i=moneyItems.length-1; i>=0; i--) {
            const m = moneyItems[i];
            if(m.side === side && Math.hypot(px-m.x, py-m.y) < 60) {
                if(m.type==='BOMB') { playTone(100,0.5); score[side]-=150000; }
                else if(m.type==='ANGPAO') { playTone(1200,0.1); score[side]+=200000; }
                else { playTone(1000,0.05); score[side]+=(m.type==='RED'?100000:50000); }
                if(score[side]<0) score[side]=0;
                moneyItems.splice(i,1);
            }
          }
        }
      }
    }

    // Draw Trails
    ['p1','p2'].forEach(s => {
        canvasCtx.beginPath(); canvasCtx.strokeStyle = s==='p1'?'#00E6FF':'#FF8A00'; canvasCtx.lineWidth=10;
        trails[s].forEach((p, i) => { if(p) i===0?canvasCtx.moveTo(p.x,p.y):canvasCtx.lineTo(p.x,p.y); });
        canvasCtx.stroke();
    });

    if(gameState==="PLAY") {
        const now = Date.now();
        timer = Math.max(0, 60 - Math.floor((now-startTime)/1000));
        timer === 0 ? endGame() : null;
        timerEl.innerText = timer;
        score1El.innerText = formatRupiah(score.p1); score2El.innerText = formatRupiah(score.p2);

        if(Math.random()<SPAWN_PROB_BASE && moneyItems.length<MAX_ITEMS) moneyItems.push(new Money(Math.random()<0.5?'p1':'p2'));
        moneyItems.forEach((m, i) => m.update() ? m.draw() : moneyItems.splice(i,1));
    }
  });

  const camera = new Camera(videoElement, {
    onFrame: async () => {
      if(performance.now()-lastMp < MP_INTERVAL) return;
      lastMp = performance.now();
      await hands.send({ image: videoElement });
    },
    width:1280, height:720
  });

  function endGame() {
    gameState = "RESULT";
    flash.style.animation = "do-flash 0.5s forwards";
    document.getElementById('result-overlay').classList.remove('hidden');
    document.getElementById('game-hud').classList.add('hidden');
    
    document.getElementById('final-score1').innerText = formatRupiah(score.p1);
    document.getElementById('final-score2').innerText = formatRupiah(score.p2);
    document.getElementById('winner-text').innerText = score.p1 > score.p2 ? "PLAYER 1 SULTAN!" : "PLAYER 2 SULTAN!";
    
    // Simple Cert Render
    const certCanvas = document.createElement('canvas');
    certCanvas.width=800; certCanvas.height=400;
    const ctx = certCanvas.getContext('2d');
    ctx.fillStyle="#064E3B"; ctx.fillRect(0,0,800,400);
    ctx.strokeStyle="#FDE047"; ctx.lineWidth=10; ctx.strokeRect(20,20,760,360);
    ctx.fillStyle="#FDE047"; ctx.font="bold 40px Arial"; ctx.textAlign="center";
    ctx.fillText("SERTIFIKAT SULTAN THR", 400, 100);
    ctx.fillStyle="#FFF"; ctx.font="30px Arial";
    ctx.fillText(score.p1 > score.p2 ? "PLAYER 1" : "PLAYER 2", 400, 200);
    ctx.fillText(formatRupiah(Math.max(score.p1, score.p2)), 400, 280);
    document.getElementById('cert-preview').src = certCanvas.toDataURL();
  }

  // Buttons Logic
  document.getElementById('btn-start').onclick = () => {
    startTime = Date.now(); gameState="PLAY";
    document.getElementById('menu-overlay').classList.add('hidden');
    document.getElementById('game-hud').classList.remove('hidden');
    if(audioCtx) audioCtx.resume();
  };

  document.getElementById('btn-toggle-game-mirror').onclick = function() {
    GAME_MIRROR = !GAME_MIRROR;
    this.innerText = `MIRROR GAMEPLAY: ${GAME_MIRROR?'ON':'OFF'}`;
  };

  document.getElementById('btn-open-cam').onclick = () => {
    document.getElementById('cam-overlay').classList.remove('hidden');
    document.getElementById('cam_preview').srcObject = videoElement.srcObject;
  };

  document.getElementById('btn-cap-p1').onclick = () => {
    const c = document.createElement('canvas'); c.width=200; c.height=200;
    c.getContext('2d').drawImage(document.getElementById('cam_preview'), 0,0,200,200);
    const data = c.toDataURL();
    document.getElementById('cap-p1').src = data; document.getElementById('preview-p1').src = data; document.getElementById('avatar-p1').src = data;
    userPhotos.p1 = data;
  };

  document.getElementById('btn-cap-p2').onclick = () => {
    const c = document.createElement('canvas'); c.width=200; c.height=200;
    c.getContext('2d').drawImage(document.getElementById('cam_preview'), 0,0,200,200);
    const data = c.toDataURL();
    document.getElementById('cap-p2').src = data; document.getElementById('preview-p2').src = data; document.getElementById('avatar-p2').src = data;
    userPhotos.p2 = data;
  };

  document.getElementById('btn-continue').onclick = () => document.getElementById('cam-overlay').classList.add('hidden');
  document.getElementById('btn-close-cam').onclick = () => document.getElementById('cam-overlay').classList.add('hidden');

  camera.start();
})();
</script>
</body>
</html>